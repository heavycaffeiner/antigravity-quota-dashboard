server {
    listen 80;
    server_name localhost;

    root /usr/share/nginx/html;
    index index.html;

    # SPA Routing: 모든 요청을 index.html로 돌림
    location / {
        try_files $uri $uri/ /index.html;
    }

    # Security Headers
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://accounts.google.com https://oauth2.googleapis.com https://www.googleapis.com;";
    add_header X-Frame-Options "DENY";
    add_header X-Content-Type-Options "nosniff";
    add_header Referrer-Policy "strict-origin-when-cross-origin";

    # Resolver 설정 (Google 도메인 해석을 위해 필요)
    resolver 8.8.8.8;

    # 1. Production Endpoint Proxy
    location /api/prod/ {
        # CORS Preflight 처리 (Optional, 브라우저가 Same Origin으로 인식하므로 필수는 아니지만 안전장치)
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' '*';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS';
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization';
            add_header 'Access-Control-Max-Age' 1728000;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }

        # URL Rewrite: /api/prod/xxx -> /xxx
        rewrite ^/api/prod/(.*) /$1 break;

        # Proxy Pass
        proxy_pass https://cloudcode-pa.googleapis.com;
        
        # SNI 설정 (Google Cloud API 호출 시 필수)
        proxy_ssl_server_name on;
        proxy_ssl_protocols TLSv1.2 TLSv1.3;

        # Header Injection (Vite Config와 동일하게 설정)
        proxy_set_header User-Agent "antigravity/1.11.5 windows/amd64";
        proxy_set_header X-Goog-Api-Client "google-cloud-sdk vscode_cloudshelleditor/0.1";
        
        # Host 헤더는 타겟 도메인으로 변경
        proxy_set_header Host cloudcode-pa.googleapis.com;
    }

    # 2. Daily Sandbox Endpoint Proxy
    location /api/daily/ {
        rewrite ^/api/daily/(.*) /$1 break;
        proxy_pass https://daily-cloudcode-pa.sandbox.googleapis.com;
        proxy_ssl_server_name on;
        
        proxy_set_header User-Agent "antigravity/1.11.5 windows/amd64";
        proxy_set_header X-Goog-Api-Client "google-cloud-sdk vscode_cloudshelleditor/0.1";
        proxy_set_header Host daily-cloudcode-pa.sandbox.googleapis.com;
    }

    # 3. Autopush Sandbox Endpoint Proxy
    location /api/autopush/ {
        rewrite ^/api/autopush/(.*) /$1 break;
        proxy_pass https://autopush-cloudcode-pa.sandbox.googleapis.com;
        proxy_ssl_server_name on;
        
        proxy_set_header User-Agent "antigravity/1.11.5 windows/amd64";
        proxy_set_header X-Goog-Api-Client "google-cloud-sdk vscode_cloudshelleditor/0.1";
        proxy_set_header Host autopush-cloudcode-pa.sandbox.googleapis.com;
    }
}
